# SillyTavern 日记本插件

一个功能完整的日记系统插件，为SillyTavern提供智能日记记录、管理和展示功能。

## 🌟 主要特性

### 📝 智能日记记录
- **自动监听**：监听AI回复，自动识别日记格式并保存
- **手动记录**：一键记录最新消息中的日记内容
- **格式识别**：支持特定日记格式的智能解析和验证

### 🎨 精美界面展示
- **沉浸式日记本**：仿真书本界面，提供优雅的阅读体验
- **角色分类**：按角色自动分类管理日记
- **分页浏览**：支持大量日记的分页展示
- **详情查看**：完整的日记内容展示和管理

### ⚙️ 智能预设管理
- **自动切换**：写日记时自动切换到专用预设
- **智能恢复**：完成后自动恢复之前的预设
- **预设发现**：自动发现和缓存可用预设

### 👥 自定义角色支持
- **角色选择**：支持为不同角色写日记
- **自定义名称**：可以使用自定义角色名称
- **灵活管理**：每个角色独立的日记管理

### 📱 移动端优化
- **响应式设计**：完美适配移动设备
- **触控优化**：针对触摸操作优化的交互体验
- **性能调优**：移动端专用的性能优化

### 🛠️ 高级功能
- **自动删除**：保存成功后自动删除聊天记录
- **数据导出**：支持JSON格式的日记数据导出
- **批量管理**：支持批量删除和清理操作
- **世界书存储**：基于SillyTavern世界书的可靠存储

## 🚀 安装方法

### 方法一：通过SillyTavern内置安装器
1. 打开SillyTavern
2. 进入扩展管理界面
3. 使用内置安装器搜索"diary"或"日记本"
4. 点击安装并重启SillyTavern

### 方法二：手动安装
1. 下载插件文件到SillyTavern的扩展目录：
   ```
   [SillyTavern目录]/public/scripts/extensions/third-party/SillyTavern-Diary/
   ```
2. 重启SillyTavern
3. 在扩展设置中找到"📖 日记本 Diary"并启用

## 📖 使用指南

### 基本设置
1. **预设配置**：在插件设置中选择专用的日记预设（可选）
2. **世界书设置**：配置日记数据存储的世界书名称（默认："日记本"）
3. **高级选项**：根据需要调整自动删除和移动端优化设置

### 日记格式
插件识别以下格式的日记内容：
```
［日记标题：今天的美好时光］
［日记时间：2024-01-01 18:30:00］
［日记内容：
今天过得很充实，和朋友们一起度过了愉快的时光。
天气很好，心情也很不错。希望明天也能有这样的好心情。
］
```

**重要提示**：
- 必须使用**全角方括号**：［ ］
- 标题、时间、内容都不能为空
- 支持多行内容和特殊字符

### 主要功能使用

#### 📚 打开日记本
- 点击"打开日记本"按钮
- 浏览所有保存的日记
- 按角色分类查看
- 支持删除操作

#### ✏️ 写日记
1. 点击"写日记"按钮
2. 选择角色（可以使用当前角色或输入自定义名称）
3. 系统自动发送日记提示给AI
4. AI回复后自动识别并保存日记
5. 可选择自动删除聊天记录

#### 📝 记录
- 用于手动处理最新AI消息
- 适合已经收到日记格式回复的情况
- 一键识别和保存

### 高级功能

#### 预设管理
- **智能切换**：写日记时自动切换到专用预设
- **自动恢复**：完成后恢复原预设
- **预设发现**：自动发现系统中的可用预设
- **缓存优化**：智能缓存提高响应速度

#### 数据管理
- **导出功能**：导出所有日记为JSON格式
- **清空数据**：批量清空所有日记（需确认）
- **统计信息**：显示日记总数和角色数量
- **世界书集成**：基于SillyTavern世界书的可靠存储

## 🔧 技术架构

### 模块化设计
- **DiaryStorage**：数据存储和世界书管理
- **PresetManager**：智能预设切换和管理
- **DiaryParser**：消息监听和日记内容解析
- **DiaryUI**：精美的用户界面管理
- **CustomCharacterDialog**：自定义角色选择弹窗

### 数据存储
- 基于SillyTavern世界书系统
- 结构化的元数据存储
- 支持按角色分类
- 完整的CRUD操作支持

### 兼容性
- **SillyTavern版本**：支持最新稳定版
- **浏览器支持**：现代浏览器（Chrome、Firefox、Safari、Edge）
- **设备支持**：桌面端和移动端
- **依赖库**：jQuery、lodash、toastr等（SillyTavern自带）

## 🐛 故障排除

### 常见问题

#### 日记无法保存
1. 检查日记格式是否正确（必须使用全角方括号）
2. 确认世界书名称设置正确
3. 检查SillyTavern世界书功能是否正常

#### 预设切换失败
1. 确认预设名称正确存在
2. 刷新预设列表
3. 检查移动端环境下的延迟设置

#### 界面显示异常
1. 清除浏览器缓存
2. 重启SillyTavern
3. 检查浏览器控制台错误信息

### 调试功能
插件提供调试接口（在浏览器控制台中使用）：
```javascript
// 获取存储管理器
window.diaryPlugin.getStorage()

// 获取预设管理器
window.diaryPlugin.getPresetManager()

// 获取解析器
window.diaryPlugin.getParser()

// 获取当前设置
window.diaryPlugin.getSettings()

// 重新初始化插件
window.diaryPlugin.reinitialize()
```

## 📄 更新日志

### 2.3.0 (当前版本)
- 🆕 完全重写为独立SillyTavern插件
- 🆕 模块化架构，提高稳定性和维护性
- 🆕 智能预设管理系统
- 🆕 移动端专门优化
- 🆕 自定义角色支持
- 🆕 自动删除聊天记录功能
- 🆕 数据导出和批量管理
- 🆕 完善的错误处理和重试机制

### 2.2.x
- 酒馆助手脚本版本（已废弃）

## 🤝 贡献指南

欢迎贡献代码和建议！

### 开发环境
1. 克隆仓库到SillyTavern扩展目录
2. 修改代码并测试
3. 提交Pull Request

### 报告问题
请在GitHub Issues中报告问题，包含：
- SillyTavern版本
- 浏览器和版本
- 详细的错误描述
- 复现步骤

## 📜 许可证

本项目采用MIT许可证 - 查看 [LICENSE](LICENSE) 文件了解详情。

## 🙏 致谢

- SillyTavern团队提供的优秀平台
- 社区用户的反馈和建议
- 所有贡献者的努力

---

**享受你的日记时光！** 📖✨
