# 📖 日记本插件 (SillyTavern-Diary)

**版本**: 3.0  
**适配**: SillyTavern 1.12.0+  
**状态**: ✅ 稳定版本

---

## 🎯 简介

日记本插件是一个功能完善的 SillyTavern 扩展，为您的角色对话提供完整的日记管理系统。通过智能的AI交互和优雅的界面设计，让日记记录变得轻松而有趣。

### ✨ 核心特色

- 📝 **智能写日记** - AI自动生成格式化的日记内容
- 📚 **日记本管理** - 按角色分类浏览和管理所有日记
- 🗑️ **一键删除** - 安全删除不需要的日记
- 👤 **自定义角色** - 为任意角色写日记，不限于当前角色卡
- 🎨 **主题切换** - 经典/简洁两种视觉风格随心切换
- 📱 **移动端优化** - 完整的响应式设计，支持各种屏幕尺寸
- 🎯 **悬浮窗设计** - 可拖拽的圆形悬浮窗，不影响聊天体验

---

## 📦 安装说明

### 方法一：通过 SillyTavern 内置安装器（推荐）

1. 打开 SillyTavern，进入 **扩展** 页面
2. 点击 **安装插件** 按钮
3. 在弹出的输入框中粘贴插件仓库地址：
   ```
   https://github.com/EtafCisky/SillyTavern-Diary
   ```
4. 点击确认，等待自动下载和安装
5. 重启 SillyTavern 或刷新页面
6. 在聊天页面应该能看到可拖拽的圆形悬浮窗（📖图标）

### 方法二：手动安装

1. 从 GitHub 下载插件：[https://github.com/EtafCisky/SillyTavern-Diary](https://github.com/EtafCisky/SillyTavern-Diary)
2. 将整个 `SillyTavern-Diary` 文件夹复制到以下目录：
   ```
   SillyTavern/public/scripts/extensions/third-party/
   ```
3. 重启 SillyTavern 或在扩展管理页面点击 "重新加载"
4. 在聊天页面应该能看到可拖拽的圆形悬浮窗（📖图标）

### 方法三：Git 克隆

```bash
cd [SillyTavern安装目录]/public/scripts/extensions/third-party/
git clone https://github.com/EtafCisky/SillyTavern-Diary.git SillyTavern-Diary
```

然后重启 SillyTavern 或重新加载扩展。

### 验证安装

安装成功后，您应该能看到：

- ✅ 在"扩展"页面能看到"📖 日记本"插件
- ✅ 在聊天页面能看到圆形悬浮窗（📖图标）
- ✅ 点击悬浮窗能展开三个功能按钮（📖日记本、✏️写日记、📝记录）

---

## 🚀 快速开始

### 第一步：选择主题

1. 打开 **扩展设置** 页面
2. 找到 **📖 日记本** 插件
3. 在 **🎨 主题美化** 区域选择喜欢的主题：
   - **经典** - 古典书本风格，皮革质感，金色装饰 ⭐默认
   - **简洁** - 现代简约设计，清爽界面

### 第二步：开始写日记

1. 在聊天页面找到圆形悬浮窗（📖图标）
2. 点击悬浮窗展开三个功能按钮
3. 点击 **✏️ 写日记** 按钮
4. 在弹出的对话框中：
   - 输入自定义角色名（可选）
   - 或直接点击"发送"使用当前角色卡名称
5. AI 将自动生成日记内容
6. 日记自动保存到世界书系统

### 第三步：浏览日记本

1. 点击悬浮窗的 **📖 日记本** 按钮
2. 选择角色查看该角色的所有日记
3. 点击任意日记卡片查看完整内容
4. 点击 **🗑️ 删除日记** 按钮可删除当前日记

---

## 📚 功能详解

### 1. ✏️ 写日记功能

#### 功能说明
引导AI按照标准格式创作日记，自动保存到世界书系统。

#### 使用步骤
1. **点击"写日记"按钮** → 弹出角色选择窗口
2. **选择角色**：
   - 输入自定义角色名：为任意角色写日记
   - 留空直接发送：使用当前角色卡名称
3. **等待AI生成** → 系统自动发送日记命令给AI
4. **自动解析保存** → AI回复后自动提取日记内容并保存
5. **聊天记录清理** → 自动删除日记命令和回复（保持聊天整洁）

#### 日记格式
```
［日记标题：今天的心情］
［日记时间：2025年10月5日］
［日记内容：今天天气很好，和朋友一起去了公园...］
```

#### 注意事项
- ✅ 支持任意角色名，不限于当前角色卡
- ✅ 日记自动按角色分类存储
- ✅ 重复标题会覆盖旧日记
- ✅ 聊天记录自动清理，不影响后续对话

### 2. 📝 记录功能

#### 功能说明
手动解析聊天中已存在的日记内容并保存，适用于：
- AI已经回复了日记但未自动保存
- 批量处理历史日记内容
- 写日记功能失败后的补救

#### 使用步骤
1. 确保聊天中最新消息包含日记格式内容
2. 点击 **📝 记录** 按钮
3. 系统自动解析最新消息并保存
4. 显示成功提示

### 3. 📖 日记本功能

#### 浏览日记
1. **打开日记本** → 点击"日记本"按钮
2. **封面页** → 显示统计信息：
   - 📊 日记总数
   - 👥 角色数量
3. **角色列表** → 点击"打开日记本"进入
   - 显示所有有日记的角色
   - 每个角色卡片显示日记数量
4. **日记列表** → 点击角色卡片查看该角色的日记
   - 按时间排序显示
   - 分页浏览（每页10篇）
5. **日记详情** → 点击日记卡片查看完整内容
   - 显示标题、时间、内容
   - 支持删除操作

#### 删除日记
1. 在日记详情页
2. 点击 **🗑️ 删除日记** 按钮
3. 确认删除
4. 日记从世界书中永久删除

#### 导航操作
- **返回按钮** - 返回上一级页面
- **分页按钮** - 浏览更多日记
- **关闭按钮** - 关闭日记本弹窗

### 4. 🎨 主题切换

#### 可用主题

| 主题名称 | 风格 | 特点 |
|---------|------|------|
| **经典 ⭐** | 古典书本风格 | • 精致的皮革质感背景<br>• 华丽的金色装饰效果<br>• 纸张纹理和装订线细节<br>• 古典字体和优雅动画 |
| **简洁** | 现代简约设计 | • 清爽的白色界面<br>• 流畅的交互体验<br>• 简洁的卡片布局<br>• 现代化的渐变色彩 |

#### 切换方法
1. 打开 **扩展设置** → **📖 日记本**
2. 在 **🎨 主题美化** 区域
3. 从下拉菜单选择主题
4. 主题立即切换并自动保存

#### 主题说明
每个主题下方会显示详细描述，帮助您了解主题特点。主题选择会自动保存，下次启动时恢复。

### 5. ⚙️ 预设管理

#### 功能说明
配置专用的日记写作预设，优化AI的日记生成效果。

#### 使用方法
1. 在扩展设置中点击 **配置预设** 按钮
2. 在弹出窗口中选择预设
3. 系统显示当前使用的预设名称

> **提示**: 预设功能可以让您为不同角色或风格设置不同的日记生成规则。

### 6. 🎯 悬浮窗控制

#### 悬浮窗功能
- **拖拽移动** - 长按悬浮窗可拖拽到任意位置
- **展开/收起** - 点击切换菜单显示/隐藏
- **位置记忆** - 自动保存窗口位置
- **智能交互** - 拖拽时不会触发菜单

#### 控制选项
- **显示/隐藏悬浮窗** - 在设置中切换悬浮窗可见性
- **重置位置** - 将悬浮窗恢复到默认位置

---

## 🔧 技术细节

### 存储系统

#### 世界书集成
- 所有日记存储在名为 **"日记本"** 的世界书中
- 自动创建和管理，无需手动操作

#### 存储格式
```javascript
{
  comment: "标题-时间",     // 条目名称
  key: ["角色名"],          // 关键词（角色名）
  content: "实际日记内容"    // 条目内容
}
```

#### 分类机制
- 按角色名作为关键词分类
- 支持自定义角色名
- 同一角色的日记自动归类

### 智能特性

#### 内容解析
- 使用正则表达式智能提取日记内容
- 自动过滤模板格式（如 `{{标题}}` 等）
- 验证内容有效性，防止空日记

#### 自动清理
- 保存成功后自动删除日记命令和AI回复
- 保持聊天记录整洁
- 防止误删保护机制

#### 错误处理
- 完整的异常捕获和用户提示
- 详细的控制台日志
- 友好的错误信息

---

## 👨‍💻 开发者指南

### 添加新主题

想要为插件创建自己的主题？按以下步骤操作：

#### 1. 创建 CSS 文件
在插件目录创建新的 CSS 文件：
```
SillyTavern-Diary/style-mytheme.css
```

#### 2. 注册主题
编辑 `index.js`，在 `THEMES` 对象中添加：

```javascript
const THEMES = {
    classic: { ... },
    simple: { ... },
    
    // 添加新主题
    mytheme: {
        id: 'mytheme',                    // 唯一ID
        name: '我的主题',                  // 显示名称
        description: '这是一个很棒的主题',  // 主题描述
        cssFile: 'style-mytheme.css'      // CSS文件名
    }
};
```

#### 3. 设计样式
新主题 CSS 必须包含以下样式：

**必需样式类：**
- `.diary-plugin-settings` - 插件设置页面
- `.diary-float-window` - 悬浮窗
- `.diary-custom-character-dialog` - 自定义角色弹窗
- `.diary-book-dialog` - 日记本弹窗
- `.diary-preset-dialog` - 预设管理弹窗
- `.diary-book-character-list` - 角色列表
- `.diary-book-diary-list` - 日记列表
- `.diary-book-detail` - 日记详情

**推荐结构：**
```css
/* ===== 插件设置页面样式 ===== */
.diary-plugin-settings { ... }

/* ===== 悬浮窗样式 ===== */
.diary-float-window { ... }

/* ===== 弹窗样式 ===== */
.diary-custom-character-dialog { ... }
.diary-book-dialog { ... }
.diary-preset-dialog { ... }

/* ===== 页面视图样式 ===== */
.diary-book-character-list { ... }
.diary-book-diary-list { ... }
.diary-book-detail { ... }

/* ===== 响应式设计 ===== */
@media (max-width: 768px) { ... }
```

#### 4. 参考资料
- **经典主题**: 参考 `style-classic.css`
- **简洁主题**: 参考 `style-simple.css`
- **HTML 结构**: 参考 `index.html`

### 技术实现

#### 主题加载机制
```javascript
// 启动时
loadSettings() → loadTheme(selectedTheme)

// 切换时
用户选择 → switchTheme(themeId) → loadTheme(themeId) + 保存设置

// CSS加载
loadTheme() → 移除旧CSS → 创建新CSS → 添加到<head>
```

#### API 集成
```javascript
// 世界书操作
import { loadWorldInfo, saveWorldInfo, createWorldInfoEntry } from "world-info.js";

// 聊天操作
import { sendMessageAsUser, Generate, chat } from "script.js";

// 命令系统
import { executeSlashCommandsWithOptions } from "slash-commands.js";
```

---

## 🐛 故障排查

### 主题相关问题

#### 主题切换后样式不生效
1. 检查浏览器开发者工具的 Network 标签，确认 CSS 文件已加载
2. 检查 CSS 文件路径是否正确
3. 清除浏览器缓存后重试
4. 查看控制台是否有 CSS 语法错误

#### 主题选择不保存
1. 检查浏览器的 LocalStorage 是否被禁用
2. 查看控制台是否有保存错误信息
3. 尝试重启 SillyTavern

### 功能相关问题

#### 写日记后没有保存
1. 检查 AI 回复是否包含正确的日记格式
2. 打开控制台查看详细日志
3. 检查世界书 "日记本" 是否被手动删除
4. 尝试使用"记录"功能手动保存

#### 日记本打开后无内容
1. 确认已经写过至少一篇日记
2. 检查世界书 "日记本" 中是否有条目
3. 查看控制台是否有加载错误

#### 悬浮窗不显示
1. 检查扩展是否正确安装
2. 在设置中点击 "显示/隐藏悬浮窗"
3. 点击 "重置悬浮窗位置"
4. 刷新页面

#### AI 生成的日记格式不正确
1. 检查是否配置了专用的日记预设
2. 在预设中添加日记格式说明
3. 使用"记录"功能可以解析任意包含标准格式的内容

### 获取帮助

如果问题仍未解决：
1. 打开浏览器开发者工具（F12）
2. 查看 Console 标签中的错误信息
3. 复制错误信息并报告问题
4. 提供操作步骤和截图

---

## 📊 版本历史

### v3.0.0 (当前版本)
- ✅ 完整的日记本浏览功能
- ✅ 一键删除日记功能
- ✅ 主题切换系统（经典/简洁）
- ✅ 优化移动端体验
- ✅ 改进错误处理和用户反馈

### v2.0.0
- ✅ 自定义角色选择功能
- ✅ 智能楼层自动删除
- ✅ 记录功能实现
- ✅ 完整的写日记工作流

### v1.0.0
- ✅ 基础插件架构
- ✅ 可拖拽悬浮窗
- ✅ 世界书集成
- ✅ 基本的日记写作功能

---

## 📄 许可证

本项目采用 MIT 许可证。

---

## 🙏 致谢

感谢 SillyTavern 团队提供优秀的扩展 API 系统。

---

**💡 提示**: 如果您喜欢这个插件，欢迎分享给朋友或提供反馈建议！

**🔗 相关链接**:
- [插件 GitHub 仓库](https://github.com/EtafCisky/SillyTavern-Diary)
- [SillyTavern 官方文档](https://docs.sillytavern.app/)
- [插件开发指南](https://docs.sillytavern.app/extensions/writing-extensions/)

---

*最后更新: 2025-10-05*  
*维护者: 日记本插件开发团队*